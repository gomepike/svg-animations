<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Divisor Machine</title>

    <style>
        #left_hand {
            transform-origin: 50% 10%;
        }

        #right_hand {
            transform-origin: 50% 10%;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 0px 0px;
            grid-auto-flow: row;
            grid-template-areas:
                "Main . ."
                "Main . ."
                "Main . .";
        }

        .Main {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 0.2fr 1fr 1.8fr 1fr;
            gap: 0px 0px;
            grid-auto-flow: row;
            grid-template-areas:
                ". . ."
                "L1 L2 ."
                "L1 L3 ."
                ". L4 .";
            grid-area: Main;
        }

        .L1 {
            grid-area: L1;
        }

        .L2 {
            grid-area: L2;
        }

        .L3 {
            grid-area: L3;
        }

        .L4 {
            grid-area: L4;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="Main">
            <div class="L1">
                <svg width="800" height="1000" transform="translate(0,-100)" xmlns="http://www.w3.org/2000/svg">
                    <g id="dividend_box">
                        <title>Dividend</title>
                        <g id="dividend_case">
                            <rect transform="rotate(2.82952 273 420)" stroke-width="0" id="svg_2" height="26"
                                width="232" y="407" x="157" stroke="#000" fill="#8CD79F" />
                            <rect stroke-width="0" id="svg_1" height="289" width="26" y="139" x="155" stroke="#000"
                                fill="#8CD79F" />
                        </g>
                        <g id="dividend_bar" transform="translate(0, -52)">
                            <rect transform="rotate(1.84501 369.026 334.389)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="330.5598" x="356.80492" fill="#FABA6F" />
                            <rect stroke-width="0" stroke="#000" id="svg_3" height="161" width="20" y="330" x="349"
                                fill="#FABA6F" />
                        </g>
                    </g>
                    <g id="divisor_box" transform="translate(275,-200)">
                        <title>Divisor</title>
                        <g id="divisor_case">
                            <rect transform="rotate(2.82952 401.491 390.741)" stroke-width="0" id="svg_7" height="26"
                                width="232" y="415" x="156" stroke="#000" fill="#8CD79F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_6" height="50.37964" width="26" y="370" x="155"
                                fill="#8CD79F"></rect>
                        </g>
                        <g id="divisor_bar" transform="translate(0, 20)">
                            <rect transform="rotate(1.84501 492.689 375.82)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="384" x="355" fill="#FABA6F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_3" height="48.58636" width="20" y="380" x="349"
                                fill="#FABA6F"></rect>
                        </g>
                    </g>
                    <g id="quotient_box" transform="translate(275,180)">
                        <title>Quotient</title>
                        <g id="quotient_case">
                            <rect transform="rotate(2.82952 273 420)" stroke-width="0" id="svg_2" height="26"
                                width="232" y="407" x="157" stroke="#000" fill="#8CD79F" />
                            <rect stroke-width="0" transform="translate(2,200) scale(1,0.5)" id="svg_1" height="289"
                                width="26" y="139" x="155" stroke="#000" fill="#8CD79F" />
                        </g>
                        <g id="quotient_bar" transform="translate(0, 30)">
                            <rect transform="rotate(1.84501 369.026 334.389)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="330.5598" x="356.80492" fill="#FABA6F" />
                            <rect stroke-width="0" stroke="#000" id="svg_3" height="161" width="20" y="330" x="349"
                                fill="#FABA6F" />
                        </g>
                    </g>
                    <g id="remainder_box" transform="translate(275,400)">
                        <title>Remainder</title>
                        <g id="remainder_case">
                            <rect transform="rotate(2.82952 401.491 390.741)" stroke-width="0" id="svg_7" height="26"
                                width="232" y="415" x="156" stroke="#000" fill="#8CD79F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_6" height="50.37964" width="26" y="370" x="155"
                                fill="#8CD79F"></rect>
                        </g>
                        <g id="remainder_bar" transform="translate(0, 20)">
                            <rect transform="rotate(1.84501 492.689 375.82)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="384" x="355" fill="#FABA6F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_3" height="48.58636" width="20" y="380" x="349"
                                fill="#FABA6F"></rect>
                        </g>
                    </g>
                    <script type="text/javascript">
                        // TODO class carrier 

                        // TODO path for animation (pipe)

                        class Container {
                            constructor(module) {
                                this.id = module + "_case";
                                this.bar = module + "_bar";
                                this.circles = [];
                                this.barPosition = -54;
                            }

                            getTotal() {
                                return this.circles.length;
                            }

                            moveTo(otherContainer) {
                                document.getElementById(otherContainer.id).appendChild(this.svg);
                                // remove from circles
                            }
                            // drop y 16 (radius*2 of circles)
                            async lowerBar() {
                                let maxMove = 76 - Math.ceil(this.circles.length / 10) * 16;
                                let barId = this.bar;
                                let currentBarPos = this.barPosition;
                                await new Promise((resolve, reject) => {
                                    for (let i = 0; i <= 100; i++) {
                                        setTimeout(function timer() {
                                            document.getElementById(barId).setAttribute('transform',
                                                "translate(0," + (currentBarPos + (maxMove -
                                                    currentBarPos) * 1.0 * i / 100) + ")");
                                            if (i >= 100) {
                                                resolve(maxMove)
                                            }
                                        }, i * 10);
                                    }
                                }).then((maxMove) => {
                                    this.barPosition = maxMove;
                                });
                            }

                            // drop y 16 (radius*2 of circles)
                            async lowerBarByOne() {
                                let maxMove = 16;
                                let barId = this.bar;
                                let currentBarPos = this.barPosition;
                                console.log(currentBarPos);

                                await new Promise((resolve, reject) => {
                                    for (let i = 0; i <= 100; i++) {
                                        setTimeout(function timer() {
                                            document.getElementById(barId).setAttribute('transform',
                                                "translate(0," + (currentBarPos + maxMove *
                                                    1.0 * i / 100) + ")");
                                            if (i >= 100) resolve(currentBarPos + maxMove)
                                        }, i * 10);
                                    }
                                }).then((newPos) => {
                                    this.barPosition = newPos;
                                });
                            }
                            // drop y 16 (radius*2 of circles)
                            async squeezeBar(size) {
                                let count = size > 0 ? size : this.circles.length;
                                console.log(this.circles);
                                await new Promise((resolve, reject) => {
                                    for (let j = 1; j <= count * 10; j++) {

                                        let animationMove = (100 - count * 10) * j / (count * 10);
                                        let divisorBar = document.getElementById(this.bar);
                                        setTimeout(function timer() {
                                            divisorBar.setAttribute('transform', "translate(" + -
                                                1.583 *
                                                animationMove + "," + (20 - j / 10) + ")")
                                            if (j >= count * 10) resolve()
                                        }, j * 16);
                                    }
                                });

                            }
                        }

                        class Circle {
                            constructor(id, r, cy, cx, translateX, translateAngle) {
                                this.rx = r;
                                this.ry = r;
                                this.stroke = "#000";
                                this.fill = "#CE7975"
                                this.id = id;
                                this.cx = cx;
                                this.cy = cy;
                                this.strokeWidth = 0;
                                this.translateX = translateX;
                                this.translateAngle = translateAngle;
                                this.svg = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                            }

                            createSVG() {
                                this.svg.setAttribute('stroke', this.stroke);
                                this.svg.setAttribute('ry', this.ry);
                                this.svg.setAttribute('rx', this.rx);
                                this.svg.setAttribute('stroke-width', this.strokeWidth);
                                this.svg.setAttribute('fill', this.fill);
                                this.svg.setAttribute('id', this.id);
                                this.svg.setAttribute('cy', this.cy);
                                this.svg.setAttribute('cx', this.cx);
                                this.svg.setAttribute('transform', "translate(" + this.translateX + ", 1) rotate(" +
                                    this.translateAngle + ")");
                                return this.svg;
                            }

                            moveOuterCircle(toX, toY) {
                                for (i = 0; i <= 100; i++) {
                                    // TODO set circular x - y
                                    this.svg.setAttribute('cy', this.cy);
                                    this.svg.setAttribute('cx', this.cx);
                                    this.svg.setAttribute('transform', "translate(" + this.translateX +
                                        ", 1) rotate(" +
                                        this.translateAngle + ")");
                                    setTimeout(function timer() {
                                        svg.appendChild(circle);
                                    }, i * 10);
                                }
                            }

                            dropLower(toY) {
                                for (i = 0; i <= 100; i++) {

                                    this.svg.setAttribute('cy', this.cy);
                                    this.svg.setAttribute('cx', this.cx);
                                    this.svg.setAttribute('transform', "translate(" + toY + ");");
                                    setTimeout(function timer() {
                                        svg.appendChild(circle);
                                    }, i * 10);
                                }
                            }

                        }
                        let dividentContainer = new Container("dividend");
                        let divisorContainer = new Container("divisor");
                        let quotientContainer = new Container("quotient");
                        let remainderContainer = new Container("remainder");

                        const svg = document.getElementsByTagName("svg")[0];

                        async function fillCircles(count) {
                            var cx = 195.5;
                            let rowCount = count / 10;
                            await new Promise((resolve, reject) => {
                                for (let row = 1; row <= rowCount + 1; row++) {
                                    for (let col = 10; col >= 1; col--) {
                                        if (row > rowCount && (10 - col) >= count % 10) break;
                                        const cy = 417.5 - 18 * row;
                                        const translateX = 18 * (col - 1) - 18;
                                        const translateAngle = -0.25 * (10 - col) - 0.25;
                                        const circle = new Circle("circle_" + row * 10 + col, 8, cy, cx,
                                            translateX,
                                            translateAngle).createSVG();
                                        setTimeout(function timer() {
                                            svg.appendChild(circle);
                                            dividentContainer.circles.push(circle);
                                            if ((row - 1) * 10 + (11 - col) >= count) resolve();
                                        }, ((row - 1) * 10 + 10 - col) * 100);
                                    }

                                }
                            });

                        }
                        async function moveBall() {

                            await new Promise((resolve, reject) => {
                                let count = Math.ceil(dividentContainer.circles.length / 10);
                                for (let i = 1; i <= count; i++) {
                                    for (let j = 1; j <= 100; j++) {
                                        setTimeout(function timer() {
                                            let topCircles = dividentContainer.circles.slice(-1*(dividentContainer.circles.length%10));

                                            for (moving of topCircles) {
                                                moving.setAttribute("cx", parseFloat(moving
                                                        .getAttribute("cx")) + j *
                                                    0.2);
                                                if (j > 20) {
                                                    moving.setAttribute("cy", parseFloat(moving
                                                            .getAttribute("cy")) +
                                                        j * 0.2);
                                                }
                                                
                                            }


                                            if (j >= 100 && i >= count) resolve()
                                        }, j * 30)
                                    }
                                    dividentContainer.lowerBarByOne()
                                }
                            });
                        }


                        const dividerSvg = document.getElementById("divisor_case");

                        async function fillDivisor(count) {
                            // TODO move to two loops which is more suitable for division algorithm

                            var cx = 190;
                            await new Promise((resolve, reject) => {
                                for (let i = 1; i <= count; i++) {
                                    // TODO fix second row first element
                                    // 18 multiplier since radius is 8
                                    const cy = 394 - 18 * (Math.floor((i - 1) / 10));
                                    const translateX = 18 * ((i - 1) % 10);
                                    const translateAngle = 0.12 * ((i - 1) % 10) + 0.12;
                                    const circle = new Circle("circle_" + i, 8, cy, cx, translateX,
                                            translateAngle)
                                        .createSVG();
                                    setTimeout(function timer() {
                                        dividerSvg.appendChild(circle);
                                        divisorContainer.circles.push(circle);
                                        console.log("running fill divisor");
                                        if (i >= count) resolve()
                                    }, i * 100);

                                }
                            });

                        }

                        async function spill() {
                            dividentContainer.lowerBar();
                        }

                        fillCircles(12).then((success) => {
                            dividentContainer.lowerBar();
                        });

                        fillDivisor(4).then((success) => {
                            console.log("running squeezeBar");
                            return divisorContainer.squeezeBar(divisorContainer.circles.length);
                        }).then(() => {
                            return quotientContainer.squeezeBar(divisorContainer.circles.length);

                        }).then(() => {
                            return remainderContainer.squeezeBar(divisorContainer.circles.length);

                        }).then(() => {
                            return dividentContainer.lowerBarByOne()
                        }).then(() => {
                            moveBall()
                        });
                    </script>


                    <script type="text/javascript">

                    </script>
                </svg>
            </div>
            <div class="L2">


            </div>
            <div class="L3"></div>
            <div class="L4"></div>
        </div>
    </div>
</body>

</html>