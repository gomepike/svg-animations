<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Divisor Machine</title>

    <style>
        /* Add a black background color to the top navigation */
        .topnav {
            background-color: #333;
            overflow: hidden;
        }

        /* Style the links inside the navigation bar */
        .topnav a {
            float: left;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            font-size: 17px;
        }

        /* Change the color of links on hover */
        .topnav a:hover {
            background-color: #ddd;
            color: black;
        }

        /* Add a color to the active/current link */
        .topnav a.active {
            background-color: #04AA6D;
            color: white;
        }

        #left_hand {
            transform-origin: 50% 10%;
        }

        #right_hand {
            transform-origin: 50% 10%;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 0px 0px;
            grid-auto-flow: row;
            grid-template-areas:
                "Main . ."
                "Main . ."
                "Main . .";
        }

        .Main {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 0.2fr 1fr 1.8fr 1fr;
            gap: 0px 0px;
            grid-auto-flow: row;
            grid-template-areas:
                ". . ."
                "L1 L2 ."
                "L1 L3 ."
                ". L4 .";
            grid-area: Main;
        }

        .L1 {
            grid-area: L1;
        }

        .L2 {
            grid-area: L2;
        }

        .L3 {
            grid-area: L3;
        }

        .L4 {
            grid-area: L4;
        }
    </style>
</head>

<body>
    <div class="topnav">
        <a href="file:///home/mstf/Downloads/svg/svg-animations/scales.html">Scale</a>
        <a href="file:///home/mstf/Downloads/svg/svg-animations/addition.html">Addition</a>
        <a class="active" href="file:///home/mstf/Downloads/svg/svg-animations/division.html">Division</a>
    </div>
    <div class="container">
        <div class="Main">
            <div class="L1">
                <svg width="800" height="1000" transform="translate(0,-100)" xmlns="http://www.w3.org/2000/svg">
                    <g id="dividend_box">
                        <title>Dividend</title>
                        <g id="dividend_case">
                            <rect transform="rotate(2.82952 273 420)" stroke-width="0" id="svg_2" height="26"
                                width="232" y="407" x="157" stroke="#000" fill="#8CD79F" />
                            <rect stroke-width="0" id="svg_1" height="289" width="26" y="139" x="155" stroke="#000"
                                fill="#8CD79F" />
                        </g>
                        <g id="dividend_bar" transform="translate(0, -52)">
                            <rect transform="rotate(1.84501 369.026 334.389)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="330.5598" x="356.80492" fill="#FABA6F" />
                            <rect stroke-width="0" stroke="#000" id="svg_3" height="161" width="20" y="330" x="349"
                                fill="#FABA6F" />
                        </g>
                    </g>
                    <g id="divisor_box" transform="translate(275,-200)">
                        <title>Divisor</title>
                        <g id="divisor_case">
                            <rect transform="rotate(2.82952 401.491 390.741)" stroke-width="0" id="svg_7" height="26"
                                width="232" y="415" x="156" stroke="#000" fill="#8CD79F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_6" height="50.37964" width="26" y="370" x="155"
                                fill="#8CD79F"></rect>
                        </g>
                        <g id="divisor_bar" transform="translate(0, 20)">
                            <rect transform="rotate(1.84501 492.689 375.82)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="384" x="355" fill="#FABA6F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_3" height="48.58636" width="20" y="380" x="349"
                                fill="#FABA6F"></rect>
                        </g>
                    </g>
                    <g id="quotient_box" transform="translate(275,180)">
                        <title>Quotient</title>
                        <g id="quotient_case">
                            <rect transform="rotate(2.82952 273 420)" stroke-width="0" id="svg_2" height="26"
                                width="232" y="407" x="157" stroke="#000" fill="#8CD79F" />
                            <rect stroke-width="0" transform="translate(2,200) scale(1,0.5)" id="svg_1" height="289"
                                width="26" y="139" x="155" stroke="#000" fill="#8CD79F" />
                        </g>
                        <g id="quotient_bar" transform="translate(0, -30)">
                            <rect transform="rotate(1.84501 369.026 334.389)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="330.5598" x="356.80492" fill="#FABA6F" />
                            <rect stroke-width="0" stroke="#000" id="svg_3" height="161" width="20" y="330" x="349"
                                fill="#FABA6F" />
                        </g>
                    </g>
                    <g id="remainder_box" transform="translate(275,400)">
                        <title>Remainder</title>
                        <g id="remainder_case">
                            <rect transform="rotate(2.82952 401.491 390.741)" stroke-width="0" id="svg_7" height="26"
                                width="232" y="415" x="156" stroke="#000" fill="#8CD79F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_6" height="50.37964" width="26" y="370" x="155"
                                fill="#8CD79F"></rect>
                        </g>
                        <g id="remainder_bar" transform="translate(0, 20)">
                            <rect transform="rotate(1.84501 492.689 375.82)" stroke="#000" stroke-width="0" id="svg_4"
                                height="7.65829" width="24.4422" y="384" x="355" fill="#FABA6F"></rect>
                            <rect stroke="#000" stroke-width="0" id="svg_3" height="48.58636" width="20" y="380" x="349"
                                fill="#FABA6F"></rect>
                        </g>
                    </g>
                    <text id="dividendText" visibility="hidden" x="275" y="300" class="heavy">0</text>
                    <text id="dividerText" visibility="hidden" x="550" y="125" class="heavy">0</text>
                    <text id="quotientText" visibility="hidden" x="550" y="500" class="heavy">0</text>
                    <text id="finalText" visibility="hidden" x="550" y="750" class="heavy">0</text>

                    <script type="text/javascript">
                        class Container {
                            constructor(module) {
                                this.id = module + "_case";
                                this.bar = module + "_bar";
                                this.circles = [];
                                this.barPosition = -54;
                            }

                            getTotal() {
                                return this.circles.length;
                            }

                            moveTo(otherContainer) {
                                document.getElementById(otherContainer.id).appendChild(this.svg);
                                // remove from circles
                            }
                            // drop y 16 (radius*2 of circles)
                            async lowerBar() {
                                let maxMove = 76 - Math.ceil(this.circles.length / 10) * 16;
                                let barId = this.bar;
                                let currentBarPos = this.barPosition;
                                await new Promise((resolve, reject) => {
                                    for (let i = 0; i <= 100; i++) {
                                        setTimeout(function timer() {
                                            document.getElementById(barId).setAttribute('transform',
                                                "translate(0," + (currentBarPos + (maxMove -
                                                    currentBarPos) * 1.0 * i / 100) + ")");
                                            if (i >= 100) {
                                                resolve(maxMove)
                                            }
                                        }, i * 10);
                                    }
                                }).then((maxMove) => {
                                    this.barPosition = maxMove;
                                });
                            }

                            // drop y 16 (radius*2 of circles)
                            async lowerBarByOne() {
                                let maxMove = 16;
                                let barId = this.bar;
                                let currentBarPos = this.barPosition;
                                console.log(currentBarPos);

                                await new Promise((resolve, reject) => {
                                    for (let i = 0; i <= 100; i++) {
                                        setTimeout(function timer() {
                                            document.getElementById(barId).setAttribute('transform',
                                                "translate(0," + (currentBarPos + maxMove *
                                                    1.0 * i / 100) + ")");
                                            if (i >= 100) resolve(currentBarPos + maxMove)
                                        }, i * 10);
                                    }
                                }).then((newPos) => {
                                    this.barPosition = newPos;
                                });
                            }
                            // drop y 16 (radius*2 of circles)
                            async squeezeBar(size) {
                                let count = size > 0 ? size : this.circles.length;
                                console.log(this.circles);
                                await new Promise((resolve, reject) => {
                                    for (let j = 1; j <= count * 10; j++) {

                                        let animationMove = (100 - count * 10) * j / (count * 10);
                                        let divisorBar = document.getElementById(this.bar);
                                        setTimeout(function timer() {
                                            divisorBar.setAttribute('transform', "translate(" + -
                                                1.583 *
                                                animationMove + "," + (20 - j / 10) + ")")
                                            if (j >= count * 10) resolve()
                                        }, j * 16);
                                    }
                                });

                            }
                        }

                        class Circle {
                            constructor(id, r, cy, cx, translateX, translateAngle) {
                                this.rx = r;
                                this.ry = r;
                                this.stroke = "#000";
                                this.fill = "#CE7975"
                                this.id = id;
                                this.cx = cx;
                                this.cy = cy;
                                this.strokeWidth = 0;
                                this.translateX = translateX;
                                this.translateAngle = translateAngle;
                                this.svg = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                            }

                            createSVG() {
                                this.svg.setAttribute('stroke', this.stroke);
                                this.svg.setAttribute('ry', this.ry);
                                this.svg.setAttribute('rx', this.rx);
                                this.svg.setAttribute('stroke-width', this.strokeWidth);
                                this.svg.setAttribute('fill', this.fill);
                                this.svg.setAttribute('id', this.id);
                                this.svg.setAttribute('cy', this.cy);
                                this.svg.setAttribute('cx', this.cx);
                                this.svg.setAttribute('transform', "translate(" + this.translateX + ", 1) rotate(" +
                                    this.translateAngle + ")");
                                return this.svg;
                            }

                            moveOuterCircle(toX, toY) {
                                for (i = 0; i <= 100; i++) {
                                    // TODO set circular x - y
                                    this.svg.setAttribute('cy', this.cy);
                                    this.svg.setAttribute('cx', this.cx);
                                    this.svg.setAttribute('transform', "translate(" + this.translateX +
                                        ", 1) rotate(" +
                                        this.translateAngle + ")");
                                    setTimeout(function timer() {
                                        svg.appendChild(circle);
                                    }, i * 10);
                                }
                            }

                            dropLower(toY) {
                                for (i = 0; i <= 100; i++) {

                                    this.svg.setAttribute('cy', this.cy);
                                    this.svg.setAttribute('cx', this.cx);
                                    this.svg.setAttribute('transform', "translate(" + toY + ");");
                                    setTimeout(function timer() {
                                        svg.appendChild(circle);
                                    }, i * 10);
                                }
                            }

                        }
                        let dividentContainer = new Container("dividend");
                        let divisorContainer = new Container("divisor");
                        let quotientContainer = new Container("quotient");
                        let remainderContainer = new Container("remainder");

                        const svg = document.getElementsByTagName("svg")[0];

                        async function fillCircles(count) {
                            var cx = 195.5;
                            let rowCount = count / 10;
                            await new Promise((resolve, reject) => {
                                for (let row = 1; row <= rowCount + 1; row++) {
                                    for (let col = 10; col >= 1; col--) {
                                        if (row > rowCount && (10 - col) >= count % 10) break;
                                        const cy = 417.5 - 18 * row;
                                        const translateX = 18 * (col - 1) - 18;
                                        const translateAngle = -0.25 * (10 - col) - 0.25;
                                        const circle = new Circle("circle_" + row * 10 + col, 8, cy, cx,
                                            translateX,
                                            translateAngle).createSVG();
                                        setTimeout(function timer() {
                                            document.getElementById("dividend_box").appendChild(
                                                circle);
                                            dividentContainer.circles.push(circle);
                                            if ((row - 1) * 10 + (11 - col) >= count) resolve();
                                        }, ((row - 1) * 10 + 10 - col) * 100);
                                    }

                                }
                            });

                        }

                        async function addToQuotient(dividentValue) {
                            var cx = 185;

                            await new Promise((resolve, reject) => {
                                const row = Math.floor(quotientContainer.circles.length /
                                    dividentValue);
                                const col = quotientContainer.circles.length % dividentValue;
                                console.log("quotient:" + row + " col:" + col);
                                const cy = 398 - 18 * row;
                                const translateX = 18 * (col - 1) + 18;
                                const translateAngle = -0.25 * (dividentValue - col) - 0.25;
                                const circle = new Circle("circle_" + row * dividentValue + col,
                                    8, cy, cx,
                                    translateX,
                                    translateAngle).createSVG();
                                document.getElementById("quotient_box").appendChild(
                                    circle);
                                quotientContainer.circles.push(circle);
                                resolve()
                            });

                        }
                        async function fillBucket(count, base) {
                            var cx = 190;
                            let rowCount = count / base;
                            await new Promise((resolve, reject) => {
                                for (let row = 1; row <= rowCount + 1; row++) {
                                    for (let col = base; col >= 1; col--) {
                                        if (row > rowCount && (base - col) >= count % base) break;
                                        const cy = 420 - 18 * row;
                                        const translateX = 18 * ((col - 1) % base);
                                        const translateAngle = 0.12 * (base - col) + 0.12;
                                        const circle = new Circle("circle_" + row * 10 + col, 8, cy,
                                            cx,
                                            translateX,
                                            translateAngle).createSVG();
                                        setTimeout(function timer() {
                                            svg.appendChild(circle);
                                            dividentContainer.circles.push(circle);
                                            if ((row - 1) * base + (base - col) >= count)
                                                resolve();
                                        }, ((row - 1) * 10 + 10 - col) * 100);
                                    }

                                }
                            });

                        }
                        const dropBalls = async (current, topCircles) => {
                            return new Promise((resolve, reject) => {
                                const promises = []

                                for (moving of topCircles) {
                                    const animPromises = []

                                    for (let j = 1; j <= 10; j++) {
                                        setTimeout(function timer() {
                                            let xPos = moving.getAttribute("cx");
                                            let yPos = moving.getAttribute("cy");
                                            if (xPos > 240) {
                                                moving.setAttribute("cy", (parseFloat(
                                                        yPos) +
                                                    j * 0.20));
                                            }

                                            if (xPos < 350) {
                                                moving.setAttribute("cx", (parseFloat(
                                                        xPos) +
                                                    j * 0.25));
                                            }
                                            animPromises.push(new Promise((resolve,
                                                    reject) =>
                                                resolve()));
                                            console.log("anim:" + animPromises.length)
                                        }, j * 50)
                                    }
                                    Promise.all(animPromises);

                                    promises.push(new Promise((resolve, reject) => resolve()));

                                }
                                return Promise.all(promises);
                            });
                        }

                        async function dropBall(current) {
                            const promises = []
                            const targetX = 290;
                            const matrix = current.transform.baseVal.consolidate().matrix;
                            let xRatio = (targetX - matrix['e']) / 25;
                            let xDiv = (220 - matrix['e']) / xRatio;
                            let yRatio = (40 - matrix['f']) / xDiv;
                            console.log("x:" + matrix['e']);
                            console.log("y:" + matrix['f']);
                            console.log("xratio:" + xRatio + " yratio:" + yRatio);
                            let pushed = false;
                            for (let j = 1; j <= 25; j++) {
                                setTimeout(function timer() {
                                    let xPos = current.transform.baseVal.consolidate().matrix['e'];
                                    let yPos = current.transform.baseVal.consolidate().matrix['f'];

                                    if (xPos > 220 && yPos < 80 && xPos < 290) {
                                        yPos = parseFloat(yPos) + yRatio;
                                    }



                                    if (xPos >= 290) {
                                        xRatio = 0;
                                        yPos = yPos + yRatio;
                                        // console.log("finished at:" + j + " xPos:" + xPos + " yPos:" +   yPos)
                                    }
                                    current.setAttribute("transform", "translate(" + (
                                        parseFloat(xPos) + xRatio) + "," + yPos + ")");

                                    if (j >= 25 && !pushed) {
                                        current.setAttribute("visibility", "hidden");
                                        promises.push(addToQuotient(4));
                                        pushed = true;
                                    }
                                    promises.push(Promise.resolve(j));

                                }, j * 50)
                            }
                            return Promise.all(promises)

                        }

                        async function dropRemainder(dividerValue) {

                            await new Promise((resolve, reject) => {

                                setTimeout(function timer() {

                                    const lastRowCount = quotientContainer.circles.length %
                                        dividerValue;
                                    let topCircles = quotientContainer.circles.slice(-1 *
                                        lastRowCount);
                                    const promises = []
                                    console.log("running in remainder:" + topCircles.length);
                                    for (let i = 0; i < topCircles.length; i++) {

                                        for (let j = 1; j <= 26; j++) {
                                            setTimeout(function timer() {
                                                topCircles[i].transform.baseVal
                                                    .consolidate().matrix['f'] += 10.5;

                                                if (i >= topCircles.length - 1 && j >= 26)
                                                    resolve();
                                            }, 1500 + j * 30);

                                        }
                                    }
                                }, 1500)

                            })

                        }

                        async function moveBall() {

                            let count = Math.ceil(dividentContainer.circles.length / 10);
                            let current = dividentContainer.circles.length;
                            console.log("total:" + current + "  count:" + count);
                            const promises = []

                            for (let i = 1; i <= count; i++) {
                                console.log("moving:" + i)
                                let topCircles = dividentContainer.circles.splice(-1 * (current % 10));
                                console.log("top slice count:" + topCircles.length);
                                current = current - topCircles.length;

                                console.log("currentCount:" + current)
                                dividentContainer.lowerBarByOne();
                                for (let j = 0; j < topCircles.length; j++) {
                                    console.log("dropping:" + JSON.stringify(topCircles[j]))
                                    promises.push(dropBall(topCircles[j]));
                                }
                            }
                            return Promise.all(promises);
                        }


                        const dividerSvg = document.getElementById("divisor_case");

                        async function fillDivisor(count) {
                            // TODO move to two loops which is more suitable for division algorithm

                            var cx = 190;
                            await new Promise((resolve, reject) => {
                                for (let i = 1; i <= count; i++) {
                                    // TODO fix second row first element
                                    // 18 multiplier since radius is 8
                                    const cy = 394 - 18 * (Math.floor((i - 1) / 10));
                                    const translateX = 18 * ((i - 1) % 10);
                                    const translateAngle = 0.12 * ((i - 1) % 10) + 0.12;
                                    const circle = new Circle("circle_" + i, 8, cy, cx,
                                            translateX,
                                            translateAngle)
                                        .createSVG();
                                    setTimeout(function timer() {
                                        dividerSvg.appendChild(circle);
                                        divisorContainer.circles.push(circle);
                                        console.log("running fill divisor");
                                        if (i >= count) resolve()
                                    }, i * 100);

                                }
                            });

                        }

                        async function spill() {
                            dividentContainer.lowerBar();
                        }

                        fillCircles(14).then((success) => {
                            dividentContainer.lowerBar();
                            document.getElementById("dividendText").setAttribute("visibility", "visible");
                            document.getElementById("dividendText").textContent = 14;

                        });

                        fillDivisor(4).then((success) => {
                            console.log("running squeezeBar");
                            document.getElementById("dividerText").setAttribute("visibility", "visible");
                            document.getElementById("dividerText").textContent = 4;
                            return divisorContainer.squeezeBar(divisorContainer.circles.length);
                        }).then(() => {
                            return quotientContainer.squeezeBar(divisorContainer.circles.length);

                        }).then(() => {
                            return remainderContainer.squeezeBar(divisorContainer.circles.length);

                        }).then(() => {
                            return dividentContainer.lowerBarByOne()
                        }).then(() => {
                            console.log("moving ball")
                            return moveBall();
                        }).then(() => {
                            console.log("drop remainder")
                            return dropRemainder(4);
                        }).then(() => {
                            quotientContainer.squeezeBar(1);
                            remainderContainer.squeezeBar(2);
                            console.log("squese alls");

                            for (let i = 1; i <= 3; i++) {
                                setTimeout(function timer() {
                                    quotientContainer.circles[(4 - i)].setAttribute("visibility",
                                        "hidden");
                                    quotientContainer.circles[(8 - i)].setAttribute("visibility",
                                        "hidden");
                                    quotientContainer.circles[(12 - i)].setAttribute("visibility",
                                        "hidden");
                                    if (i === 3) {
                                        document.getElementById("quotientText").setAttribute(
                                            "visibility", "visible");
                                        document.getElementById("quotientText").textContent =
                                            "Quotient:3";
                                        document.getElementById("finalText").setAttribute("visibility",
                                            "visible");
                                        document.getElementById("finalText").textContent =
                                        "Remainder:2";

                                    }
                                }, i * 50);

                            }

                        });
                    </script>

                    <script type="text/javascript">

                    </script>
                </svg>
            </div>
            <div class="L2">


            </div>
            <div class="L3"></div>
            <div class="L4"></div>
        </div>
    </div>
</body>

</html>