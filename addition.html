<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Addition</title>

    <style>



    </style>
</head>

<body>
    <div id="mainDiv" style="width: 50%; height: auto;">
        <svg id="addition_case" viewBox="0 0 600 900" preserveAspectRatio="none" width="1600" height="1600"
            xmlns="http://www.w3.org/2000/svg">

            <g id="Layer_1">

                <title>Layer 1</title>

                <path id="svg_8" d="m29.00795,213.6768l76.2,-176.99999l101.79999,0l-68.2,178.99999l-109.79999,-2z"
                    stroke="#000" fill="#fdffde" />
                <path fill="white" stroke="#000" opacity="NaN" d="m267.60498,280.60669" id="svg_9" />
                <g id="firstBoxPlate">
                    <path stroke="#000" id="firstBoxBorder"
                        d="m143.04865,86.28779l14.69171,-38.27162l40.60562,0l-14.87006,38.33333l-40.42727,-0.0617l0,-0.00001z"
                        fill="white" />
                    <line id="svg_13" y2="85.72961" x2="155.92637" y1="48.02467" x1="170.68047" stroke="#000"
                        fill="none" />
                    <line id="svg_17" y2="86.05748" x2="170.3526" y1="48.35254" x1="185.10671" stroke="#000"
                        fill="none" />
                    <line stroke="#000" id="svg_19" y2="61.87468" x2="193.24975" y1="61.37468" x1="152.24979"
                        fill="none" />
                    <line id="svg_20" y2="73.49942" x2="188.87485" y1="72.99942" x1="147.87489" stroke="#000"
                        fill="none" />
                </g>
                <g id="secondBoxPlate">
                    <path stroke="#000" id="secondBoxBorder"
                        d="m123.42591,136.85407l14.69171,-38.27162l40.60562,0l-14.87007,38.33333l-40.42726,-0.06171z"
                        fill="white" />
                    <line id="svg_23" y2="136.29589" x2="136.30363" y1="98.59095" x1="151.05773" stroke="#000"
                        fill="none" />
                    <line id="svg_24" y2="136.62376" x2="150.72987" y1="98.91882" x1="165.48397" stroke="#000"
                        fill="none" />
                    <line stroke="#000" id="svg_25" y2="112.44097" x2="173.62701" y1="111.94097" x1="132.62705"
                        fill="none" />
                    <line id="svg_26" y2="124.0657" x2="169.25211" y1="123.5657" x1="128.25215" stroke="#000"
                        fill="none" />
                </g>
                <g id="totalBoxPlate">
                    <path stroke="#000" id="totalBoxBorder"
                        d="m103.42581,187.79771l14.69171,-38.27162l40.60562,0l-14.87007,38.33333l-40.42726,-0.06171z"
                        fill="white" />
                    <line id="svg_29" y2="187.23953" x2="116.30353" y1="149.5346" x1="131.05764" stroke="#000"
                        fill="none" />
                    <line id="svg_30" y2="187.5674" x2="130.72977" y1="149.86246" x1="145.48387" stroke="#000"
                        fill="none" />
                    <line stroke="#000" id="svg_31" y2="163.38461" x2="153.62692" y1="162.88461" x1="112.62695"
                        fill="none" />
                    <line id="svg_32" y2="175.00934" x2="149.25202" y1="174.50934" x1="108.25205" stroke="#000"
                        fill="none" />
                </g>
                <g id="carryBoxPlate">
                    <path stroke="#000" id="carryBoxBorder"
                        d="m50.218,187.79771l14.69171,-38.27162l40.60562,0l-14.87007,38.33333l-40.42726,-0.06171z"
                        fill="white" />
                    <line id="svg_35" y2="187.23953" x2="63.09573" y1="149.5346" x1="77.84983" stroke="#000"
                        fill="none" />
                    <line id="svg_36" y2="187.5674" x2="77.52196" y1="149.86246" x1="92.27607" stroke="#000"
                        fill="none" />
                    <line stroke="#000" id="svg_37" y2="163.38461" x2="100.41911" y1="162.88461" x1="59.41915"
                        fill="none" />
                    <line id="svg_38" y2="175.00934" x2="96.04421" y1="174.50934" x1="55.04425" stroke="#000"
                        fill="none" />
                </g>
            </g>

            // (39,-22) = (53, -22) = (66,-22)
            // translate(34,-10)
            <g id="svg_520" visibility="hidden" transform="translate(39,-22)">
                <rect x="116.81006" y="69.23551" width="8.80109" height="12.25433" id="svg_513" fill="#ff0026"
                    stroke="null" />
                <g id="svg_516">
                    <path d="m129.21476,59.31883l-7.98018,0.10804l-4.4615,9.91332l8.73873,0.08432l3.70295,-10.10568z"
                        id="svg_514" fill="#ff0026" stroke-width="0.3" stroke="#ffffff" />
                    <path
                        d="m130.17823,70.62361l-0.64151,-11.63597l-3.80538,10.08082l-0.0849,13.06903l4.53179,-11.51388z"
                        id="svg_515" fill="#ff0026" stroke-width="0.3" stroke="#ffffff" />
                </g>
                <g id="svg_519">
                    <path d="m129.88142,57.82222l-7.64684,0.11713l-5.62817,11.7175l8.73873,0.10099l4.53628,-11.93562z"
                        id="svg_517" fill="#ff0026" stroke-width="0.3" stroke="#ffffff" />
                    <path
                        d="m130.17823,70.95693l0.02516,-13.63595l-4.47205,12.08081l-0.0849,13.06902l4.53179,-11.51388z"
                        id="svg_518" fill="#ff0026" stroke-width="0.3" stroke="#ffffff" />
                </g>
            </g>
            <text id="firstBoxText" visibility="hidden" x="200" y="75" class="heavy">0</text>
            <text id="secondBoxText" visibility="hidden" x="180" y="125" class="heavy">0</text>
            <text id="totalBoxText" visibility="hidden" x="115" y="205" class="heavy">0</text>
            <text id="carryBoxText" visibility="hidden" x="65" y="205" class="heavy">0</text>
            <text id="finalText" visibility="hidden" x="150" y="205" class="heavy">0</text>

            <g id="firstBoxSvg">

            </g>
            <g id="secondBoxSvg">

            </g>
            <g id="totalBoxSvg">

            </g>
            <g id="carryBoxSvg">

            </g>
        </svg>
    </div>

    <script>
        var originalBar = document.getElementById('svg_520');

        class Box {
            constructor(id, xPositions, yPositions) {
                this.id = id;
                this.xPositions = xPositions;
                this.yPositions = yPositions;
                this.value = 0;
                this.color = "#ff0026"
            }
            async fillBox(count) {
                var copy = this;
                this.value = count;
                await new Promise((resolve, reject) => {
                    for (let i = 0; i < count; i++) {
                        setTimeout(function timer() {
                            var clone = originalBar.cloneNode(true); // "deep" clone
                            clone.id = copy.id + "_bar_" + i;
                            let floor = Math.floor(i / 9);
                            let line = Math.floor(i / 3) % 3;
                            if (copy.color !== "ff0026") copy.setColor(clone);

                            clone.setAttribute("transform", "translate(" + (i % 3 * 14 + copy
                                .xPositions[line]) + "," + (copy.yPositions[line] - 12 *
                                floor) + ")");
                            clone.setAttribute("visibility", "visible");
                            document.getElementById(copy.id + "Svg").appendChild(clone);
                            document.getElementById(copy.id + "Text").textContent = i + 1;

                            if (i === count - 1) resolve();
                        }, i * 300);
                    }
                })
            }

            async move(otherBox) {
                let boxes = document.getElementById(this.id + "Svg");
                let copy = this;
                await new Promise((resolve, reject) => {
                    let total = this.value;
                    let copy = this;
                    for (let i = 1; i <= total; i++) {
                        if (!boxes.lastChild.className === "SVGAnimatedString") {
                            i--;
                            boxes.removeChild(boxes.lastChild)
                            continue;
                        }
                        setTimeout(function timer() {
                            boxes.removeChild(boxes.lastChild);
                            copy.value = copy.value - 1;
                            otherBox.addOne();
                            if(otherBox.id !== "totalBox"){
                                otherBox.showNumber();
                            }
                            copy.showNumber();
                            if (i >= total) resolve()

                        }, i * 300);

                    }
                });

            }

            async addOne() {
                var clone = originalBar.cloneNode(true); // "deep" clone
                clone.id = this.id + "_bar_" + this.value;
                let floor = Math.floor(this.value / 9);
                let line = Math.floor(this.value / 3) % 3;
                if (this.color !== "ff0026") this.setColor(clone);

                clone.setAttribute("transform", "translate(" + (this.value % 3 * 14 +
                this
                    .xPositions[line]) + "," + (this.yPositions[line] -
                    12 *
                    floor) + ")");
                clone.setAttribute("visibility", "visible");
                document.getElementById(this.id + "Svg").appendChild(clone);
                document.getElementById(this.id + "Text").textContent = this.value + 1;
                this.value = this.value + 1;
            }

            async setColor(clone) {
                let paths = clone.querySelectorAll("path");
                clone.querySelectorAll("rect")[0].setAttribute("fill", this.color);
                for (let j = 0; j < paths.length; j++) {
                    paths[j].setAttribute('fill', this.color);
                }
            }

            async showNumber() {
                document.getElementById(this.id + "Text").setAttribute("visibility", "visible");
                document.getElementById(this.id + "Text").textContent = this.value;
            }

            async drop() {
                let i = this.value / 10;
                if (i < 1) return 0;
                this.value = this.value - 10;
                let boxes = document.getElementById(this.id + "Svg")
                i = 1;
                while (boxes.lastChild && i <= 10) {
                    i++;
                    boxes.removeChild(boxes.lastChild);
                }
                return 1;
            }
        }

        let firstBox = new Box("firstBox", [39, 34, 28], [-22, -10, 4])
        let secondBox = new Box("secondBox", [19, 14, 8], [29, 41, 54])
        let totalBox = new Box("totalBox", [-1, -6, -12], [80, 92, 105])
        let carryBox = new Box("carryBox", [-55, -60, -65], [80, 92, 105])
        carryBox.color = "blue";


        firstBox.showNumber();
        let first = 5;
        let second = 5;
        firstBox.fillBox(first).then(() => {
            secondBox.showNumber();
            return secondBox.fillBox(second);
        }).then(() => {
            document.getElementById(secondBox.id+"Border").setAttribute("stroke","#5aa832");
            return secondBox.move(totalBox);
        }).then(() => {
            document.getElementById(secondBox.id+"Border").setAttribute("stroke","#000");
            document.getElementById(firstBox.id+"Border").setAttribute("stroke","#5aa832");
            return firstBox.move(secondBox);
        }).then(() => {
            document.getElementById(firstBox.id+"Border").setAttribute("stroke","#000");
            document.getElementById(secondBox.id+"Border").setAttribute("stroke","#5aa832");
            return secondBox.move(totalBox);
        }).then(() => {
            document.getElementById(secondBox.id+"Border").setAttribute("stroke","#000");
            document.getElementById(totalBox.id+"Border").setAttribute("stroke","#5aa832");

             if(first+second> 9){
                totalBox.drop();
                return carryBox.fillBox((first+second)/10);
             }
        }).then(() => {
            totalBox.showNumber()
            return carryBox.showNumber()
        }).then(() => {
            document.getElementById("finalText").setAttribute("visibility", "visible");
            document.getElementById("finalText").textContent = carryBox.value * 10 + totalBox.value;
        })
    </script>

</body>

</html>